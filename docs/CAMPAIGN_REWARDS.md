# 闯关模式：奖励机制与得分体系（设计稿）

> 本文仅做数值与机制设计，不改动代码实现。
> 目标：在不破坏现有「体力 / 脑力币 / XP / 解锁树」闭环的前提下，让闯关模式形成更强的目标感、反馈感与复玩动力。

## 0. 实现状态

### 已实现 ✅
- **10章50关**：campaign_v2 SQL 迁移已创建（0007），N 从 1 提升到 5
- **星级判定**：`computeStars(accuracy)` → 90%→3★, 80%→2★, 60%→1★
- **星级金币奖励**：`campaignStarBonus` 已在 gameStore.ts 实现（1★→5, 2★→10, 3★→20）
- **闯关→自由训练解锁**：`deriveUnlocksFromCampaign` 扫描已通关关卡，自动派生 GameUnlocks
- **章节解锁条件**：前一章所有关卡 3★ 才能进入下一章
- **关卡推进**：上一关 ≥1★ 才能挑战下一关

### 待实现 ⬜
- 星级 XP 加成（§3.2 可选部分）
- 星级差额策略（当前是每次都给全额，未做 delta 逻辑）
- 章节通关宝箱 / 章节完美宝箱（§3.3）
- Campaign Points 积分展示 / 排行（§4）

## 1. 设计目标与约束

### 目标
- 强目标：玩家清楚“这一局为哪一关服务、通关线是什么、下一步是什么”
- 强反馈：结算能明确告诉玩家“本局赢在哪里/差在哪里”，并给出可执行的下一步建议
- 可复玩：重复挑战有意义，但不能被刷到通胀（尤其是 Brain Coins）
- 与现有体系一致：沿用现有 XP、Brain Coins、体力消耗与解锁规则，不引入必须落库的新货币（可选项另列）

### 现有约束（来自 PRD/路线图）
- 体力上限 5，惰性恢复：每 4 小时恢复 1 点
- 训练结算基础金币：`BrainCoins = Min(20, Round(score * 0.05))`
- 解锁奖励：触发 newlyUnlocked 时，每条解锁额外 +20 Brain Coins（不返还体力）
- 每日首胜 / 每日完美：分别额外 +15 / +30 Brain Coins（全局）
- XP 公式：`XP = 20 * (N系数 + 模式系数) * 准确率`

## 2. 闯关的“通关与星级”规则

### 2.1 通关判定（Pass）
- 每关存在通关线：`minAccuracy`（已在关卡元数据中配置）
- 本局准确率 `accuracy >= minAccuracy` 视为通关
- 未通关：不推进主线、不解锁下一关（但依然给“练习反馈”和少量奖励，见第 3 节）

### 2.2 星级判定（Stars）
星级只依赖准确率（避免不同模式的速度、步数、轮数指标难以统一）。

设 `A = accuracy`，`P = minAccuracy`：
- **1★**：`A >= P`
- **2★**：`A >= min(P + 15, 95)`（鼓励“稳过”而不是“擦线过”）
- **3★**：`A >= min(P + 30, 100)`

建议默认通关线：
- 普通关：P=60（则 1★60 / 2★75 / 3★90）
- BOSS 关：P=90（则 1★90 / 2★95 / 3★100）

> 注：如果未来想提高区分度，可给每关增加“附加挑战”维度（例如平均反应时、连击、零失误），作为 3★ 的可选替代条件，但不建议第一版就上。

## 3. 奖励体系（与现有经济融合）

闯关奖励由三部分组成：
1) **基础奖励**：沿用自由训练（XP + Brain Coins + 全局日常奖励）
2) **闯关加成**：以“星级”驱动的额外奖励（避免与 score 直接绑定造成刷分）
3) **进度奖励**：章节/里程碑奖励（更强激励，但频率更低）

### 3.1 基础奖励（沿用现有）
- XP：按现有结算公式计算（不区分自由/闯关）
- Brain Coins：按现有 `Min(20, Round(score * 0.05))`
- 解锁奖励、每日首胜、每日完美：保持全局一致

### 3.2 闯关加成（新增设计）

#### 星级金币奖励（Campaign Star Bonus）
在“基础金币”之外，按本关最终星级发放一次性的闯关星级奖励：
- 1★：+5 Coins
- 2★：+10 Coins
- 3★：+20 Coins

**防刷策略（关键）**
- 仅当“本次星级 > 历史最佳星级”时，发放“差额奖励（delta）”
  - 例：历史 1★，本次 3★，则额外获得 (20-5)=15 Coins
  - 例：历史 3★，本次 3★，则本项为 0

这样做的效果：
- 鼓励玩家把同一关打到更高星
- 不鼓励无限重复刷同一关（货币通胀风险显著降低）

#### 星级 XP 加成（可选）
如果希望“闯关比自由训练更有目标感”，可以给“通关局”一个小幅 XP 加成（仍受体力限制）：
- 1★：XP * 1.05
- 2★：XP * 1.10
- 3★：XP * 1.20

同样建议采用“delta”策略：仅对提升星级的那一局发放加成部分，避免刷 XP。

> 如果担心整体 LV 增速变快，可只对 BOSS 关开启星级 XP 加成。

### 3.3 进度奖励（章节与里程碑）

#### 章节通关宝箱（Episode Chest）
完成某一章的所有关卡（≥1★）后，发放一次性宝箱：
- Coins：+80
- 道具：`energy_1` * 1（或等价“返还 1 点体力”）
- 外观/称号：预留（不影响数值平衡）

#### 章节完美宝箱（Perfect Episode）
如果某章全关卡都达到 ≥3★：
- Coins：+200
- 道具：`energy_1` * 2（或“补签卡碎片”等后续玩法的入口）

> 章节奖励应明显强于单局奖励，但触发频率低（平均每章 5 关），能更好地形成长期目标。

## 4. 闯关得分体系（用于“闯关内排名/展示”）

> 本节定义“Campaign Points（闯关积分）”，与 Brain Coins 区分：Coins 是经济货币；Points 是展示/排行/成就用的积分。

### 4.1 闯关积分（Campaign Points）
每关产生一个“关卡积分”用于展示与后续排行：

`CampaignPoints = Base(episodeId, orderInEpisode) * StarMultiplier * FirstClearMultiplier`

- Base：建议简单、可预期
  - `Base = 100 + (episodeId - 1) * 25 + (orderInEpisode - 1) * 10`
- StarMultiplier：
  - 1★：1.0
  - 2★：1.4
  - 3★：2.0
- FirstClearMultiplier：
  - 首次 ≥1★ 通关该关：1.2
  - 否则：1.0

**为什么这么设计**
- 积分不再依赖“自由训练的 score”，避免某些模式的 score 天生更容易刷
- 星级决定倍率，保证“玩得好”比“玩得多”更有效
- 首通加成让“推进主线”更划算，减少卡关时的挫败

### 4.2 全局展示口径
- 闯关总积分：所有关卡历史最佳积分之和（而不是累计每次挑战的积分）
  - 再次挑战只有在提升星级时才会抬高总积分
- 章节积分：该章节内关卡历史最佳积分之和

## 5. 与解锁树、体力与商城的联动建议

### 5.1 解锁树联动（避免割裂）
- 闯关关卡继续依赖“配置已解锁”作为挑战资格（现有校验即可）
- BOSS 关可作为“技能检定”：
  - 通过 BOSS（≥1★）仅推进剧情
  - 达到 BOSS 3★ 才发放“强力奖励”（章节完美宝箱）或“关键解锁碎片”

### 5.2 体力联动（鼓励回流）
建议把“章节宝箱”中的一部分奖励做成体力返还/体力道具：
- 让玩家有动力每天至少打到 1★ 推进
- 又不会让体力系统失效（返还的体力来自低频奖励，而非可刷资源）

### 5.3 商城联动（未来）
闯关积分可以作为：
- 外观解锁条件（称号/头像框/主题）
- 高级报告权益的“里程碑门槛”（例如章节完美次数）

不建议让闯关积分直接兑换 Coins 或体力，避免经济系统被“积分 -> 货币”打穿。

## 6. 结算体验（闯关专属 UI 的输出点）

闯关结算页需要回答 4 个问题：
1) **过没过**：本局是否通关、差多少（例如“还差 6% 达到通关线”）
2) **拿了几星**：星级与升级路径（从 1★ 到 2★/3★ 还差多少）
3) **给了什么**：奖励拆分（基础金币/星级奖励/首通/日常加成）
4) **下一步做什么**：继续下一关 / 重试本关冲更高星 / 回地图

推荐按钮结构：
- 主按钮：下一关（若已通关并存在下一关）
- 次按钮：重试本关（若未达 3★）
- 辅助入口：回闯关地图 / 查看章节简介 / 分享战绩（后续）

## 7. 各游戏首次引导（策略建议）

首次引导建议遵循两条原则：
- **不讲规则大全**：只讲“本模式的一句话目标 + 两个最常见错误”
- **引导可重看**：在训练页提供“？”入口随时打开

每个模式建议 3 屏以内：
- 第 1 屏：一句话目标（配示意）
- 第 2 屏：判定规则（什么算对/错/漏）
- 第 3 屏：通关建议（冲星最有效的 1-2 个练法）

